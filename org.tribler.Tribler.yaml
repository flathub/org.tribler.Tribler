# Flatpak manifest for Tribler (https://www.tribler.org, https://github.com/tribler/tribler)
#
# To build the flatpak locally:
#
# flatpak install flathub runtime/org.kde.Sdk/x86_64/5.15
#
# flatpak-builder --force-clean build org.tribler.Tribler.yaml --install --user

id: org.tribler.Tribler
command: tribler
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --filesystem=xdg-download/TriblerDownloads:create
  - --persist=.Tribler
  - --own-name=org.kde.*
  - --talk-name=org.freedesktop.Notifications
modules:
  - name: tribler
    buildsystem: simple
    build-commands:
      - ar x tribler.deb
      - tar xf data.tar.xz
      - mkdir -p /app/bin
      - install tribler /app/bin
      - install -Dm644 usr/share/applications/${FLATPAK_ID}.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - |
        for size in 64 128 256 512; do
          install -Dm644 tribler_${size}.png /app/share/icons/hicolor/${size}x${size}/apps/${FLATPAK_ID}.png || exit 1
        done
      - mv usr/share/tribler /app/share
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t /app/share/metainfo
    sources:
      - type: file
        url: https://github.com/Tribler/tribler/releases/download/v7.11.0/tribler_7.11.0_all.deb
        sha256: 5ddf62f9b799776cfe3601fa883e180a056cf60147a78de67dfa77ae62a0a14f
        dest-filename: tribler.deb
        only-arches:
          - x86_64
        x-checker-data:
          type: anitya
          project-id: 241848
          stable-only: true
          url-template: https://github.com/Tribler/tribler/releases/download/v${version}/tribler_${version}_all.deb
      - type: dir
        path: icons
      - type: file
        path: org.tribler.Tribler.metainfo.xml
      - type: script
        dest-filename: tribler
        commands: 
          - exec /app/share/tribler/tribler
    post-install:
      - desktop-file-edit --set-key=Exec --set-value="/app/bin/tribler %U" /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.desktop
  - name: libsodium
    sources:
      - type: archive
        url: https://github.com/jedisct1/libsodium/releases/download/1.0.18-RELEASE/libsodium-1.0.18.tar.gz
        sha256: 6f504490b342a4f8a4c4a02fc9b866cbef8622d5df4e5452b46be121e46636c1
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gtk-doc
  - '*.la'
  - '*.deb'
  - '*.xz'
  - 'debian-binary'
  - /usr
